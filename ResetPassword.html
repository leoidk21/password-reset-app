<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 400px; margin: 100px auto; padding: 20px; }
        .container { border: 1px solid #ddd; padding: 30px; border-radius: 8px; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #ccc; }
    </style>
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        const supabaseUrl = 'https://vxukqznjkdtuytnkhldu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4dWtxem5qa2R0dXl0bmtobGR1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTI0NDE4MCwiZXhwIjoyMDc2ODIwMTgwfQ.7hCf7BDqlVuNkzP1CcbORilAzMqOHhexP4Y7bsTPRJA';
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        console.log("ðŸ”‘ ResetPassword page loaded");
        
        // Auto-process tokens from URL
        async function processTokens() {
            if (window.location.hash) {
                console.log("Processing tokens from URL...");
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const accessToken = hashParams.get('access_token');
                const refreshToken = hashParams.get('refresh_token');
                
                if (accessToken) {
                    const { data, error } = await supabase.auth.setSession({
                        access_token: accessToken,
                        refresh_token: refreshToken
                    });
                    
                    if (error) {
                        alert("Invalid or expired reset link.");
                        return;
                    }
                    console.log("âœ… Session established");
                }
            }
        }
        
        await processTokens();
        
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                alert("Passwords don't match!");
                return;
            }
            
            if (newPassword.length < 6) {
                alert("Password must be at least 6 characters!");
                return;
            }
            
            const button = e.target.querySelector('button');
            button.disabled = true;
            button.textContent = "Resetting...";
            
            try {
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                });
                
                if (error) throw error;
                
                alert("âœ… Password updated successfully!");
                await supabase.auth.signOut();
                
            } catch (error) {
                alert("âŒ Failed to reset password: " + error.message);
            } finally {
                button.disabled = false;
                button.textContent = "Reset Password";
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <h2>Reset Your Password</h2>
        <form id="resetForm">
            <input type="password" id="newPassword" placeholder="New Password" required>
            <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
            <button type="submit">Reset Password</button>
        </form>
    </div>
</body>
</html>